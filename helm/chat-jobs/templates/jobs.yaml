# MongoDB Seed Job
{{- if .Values.jobs.mongoSeed.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: mongo-seed-job
  namespace: {{ .Values.global.namespace }}
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mongo-seeder
        image: {{ .Values.jobs.mongoSeed.image }}
        command:
          - /bin/sh
          - -c
          - |
            echo "Running seed script..."
            mongo "mongodb://$MONGO_INITDB_ROOT_USERNAME:$MONGO_INITDB_ROOT_PASSWORD@mongodb:27017/admin" \
              --eval "var DB_NAME='chatdb', ADMIN_USER='admin', ADMIN_EMAIL='admin@example.com', ADMIN_PASS='$MONGO_INITDB_ROOT_PASSWORD'" \
              /scripts/seed.js
            echo "‚úÖ Seed finished successfully."
        env:
          - name: MONGO_INITDB_ROOT_USERNAME
            valueFrom:
              secretKeyRef:
                name: mongodb-credentials
                key: mongo_username
          - name: MONGO_INITDB_ROOT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mongodb-credentials
                key: mongo_password
        volumeMounts:
          - name: seed-script
            mountPath: /scripts
        resources:
          requests:
            cpu: {{ .Values.jobs.mongoSeed.resources.requests.cpu }}
            memory: {{ .Values.jobs.mongoSeed.resources.requests.memory }}
          limits:
            cpu: {{ .Values.jobs.mongoSeed.resources.limits.cpu }}
            memory: {{ .Values.jobs.mongoSeed.resources.limits.memory }}
      volumes:
        - name: seed-script
          configMap:
            name: mongo-seed-script
            defaultMode: 0777
---
{{- end }}

# Database Migration Job
{{- if .Values.jobs.dbMigration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration-job
  namespace: {{ .Values.global.namespace }}
  labels:
    app: chatapp
    job: db-migration
spec:
  backoffLimit: 2
  activeDeadlineSeconds: {{ .Values.jobs.dbMigration.activeDeadlineSeconds }}
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migration
          image: {{ .Values.jobs.dbMigration.image }}
          command:
            - /bin/sh
            - -c
            - |
              echo "üöÄ Starting DB migration..."
              mongo "mongodb://$MONGO_INITDB_ROOT_USERNAME:$MONGO_INITDB_ROOT_PASSWORD@mongodb:27017/admin" /scripts/migration.js
              status=$?
              if [ $status -ne 0 ]; then
                echo "‚ùå Migration failed with exit code $status"
                exit $status
              fi
              echo "‚úÖ Migration completed successfully."
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongo_username
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: mongo_password
          volumeMounts:
            - name: migration-script
              mountPath: /scripts
          resources:
            requests:
              cpu: {{ .Values.jobs.dbMigration.resources.requests.cpu }}
              memory: {{ .Values.jobs.dbMigration.resources.requests.memory }}
            limits:
              cpu: {{ .Values.jobs.dbMigration.resources.limits.cpu }}
              memory: {{ .Values.jobs.dbMigration.resources.limits.memory }}
      volumes:
        - name: migration-script
          configMap:
            name: db-migration-script
{{- end }}