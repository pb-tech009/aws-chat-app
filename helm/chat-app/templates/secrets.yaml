{{- if .Values.secrets.externalSecrets.enabled }}
# =============================================================================
# EXTERNAL SECRETS CONFIGURATION (Production)
# =============================================================================

# AWS Secrets Manager SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ .Values.secrets.externalSecrets.secretStore.name }}
  namespace: {{ .Values.global.namespace }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.global.awsRegion | default "us-west-2" }}
      auth:
        secretRef:
          accessKeyID:
            name: aws-credentials
            key: access-key-id
          secretAccessKey:
            name: aws-credentials
            key: secret-access-key

---
# MongoDB Credentials from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mongodb-credentials
  namespace: {{ .Values.global.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: mongodb-credentials
    creationPolicy: Owner
  data:
  - secretKey: mongo_username
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.mongoCredentials }}
      property: username
  - secretKey: mongo_password
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.mongoCredentials }}
      property: password

---
# Backend JWT Secret from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-jwt-secret
  namespace: {{ .Values.global.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: backend-jwt-secret
    creationPolicy: Owner
  data:
  - secretKey: jwt
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.jwtSecret }}
      property: jwt_secret

---
# Cloudinary Credentials from AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cloudinary-credentials
  namespace: {{ .Values.global.namespace }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStore.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStore.kind }}
  target:
    name: cloudinary-credentials
    creationPolicy: Owner
  data:
  - secretKey: cloud_name
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.cloudinaryCredentials }}
      property: cloud_name
  - secretKey: api_key
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.cloudinaryCredentials }}
      property: api_key
  - secretKey: api_secret
    remoteRef:
      key: {{ .Values.secrets.awsSecrets.cloudinaryCredentials }}
      property: api_secret

{{- else }}
# =============================================================================
# FALLBACK SECRETS (Development Only)
# =============================================================================

apiVersion: v1
kind: Secret
metadata:
  name: mongodb-credentials
  namespace: {{ .Values.global.namespace }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
type: Opaque
data:
  mongo_username: {{ .Values.secrets.fallback.mongoUsername }}
  mongo_password: {{ .Values.secrets.fallback.mongoPassword }}

---
apiVersion: v1
kind: Secret
metadata:
  name: backend-jwt-secret
  namespace: {{ .Values.global.namespace }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
type: Opaque
data:
  jwt: {{ .Values.secrets.fallback.jwt | b64enc }}

---
apiVersion: v1
kind: Secret
metadata:
  name: cloudinary-credentials
  namespace: {{ .Values.global.namespace }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
type: Opaque
data:
  cloud_name: {{ .Values.secrets.fallback.cloudName | b64enc }}
  api_key: {{ .Values.secrets.fallback.apiKey | b64enc }}
  api_secret: {{ .Values.secrets.fallback.apiSecret | b64enc }}

{{- end }}